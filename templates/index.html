<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Aneris Control Panel</title>
    <link rel="icon" href="/media/favicon.ico">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
    <h1>Aneris Control Panel</h1>
    <p>Temperature: <span id="temperature"></span></p>
    <p>Pressure: <span id="pressure"></span></p>
    <button onclick="getTempAndPres()">Update</button>

    <!-- Relay control -->
    <h2>Power Options</h2>
    <h3>Reboot</h3>
    <label style="cursor: pointer;" title="Remember to save config" for="reset_time">Reset time:</label>
    <input type="number" id="reset_time" name="reset_time"> seconds<br>
    <button style="cursor: pointer;" title="Turns of camera for 10 seconds" onclick="rebootCamera()">Reboot
        camera</button><br>
    <button style="cursor: pointer;" title="Turns of daisy chain for 10 seconds" onclick="rebootDaisy()">Reboot
        daisy chain</button><br>

    <h3>Relays</h3>
    <label for="on_off_camera" style="cursor: pointer;"
        title="Remember that when camera is off the relay solenoid is active">Camera :</label>
    <label class="switch">
        <input type="checkbox" id="on_off_camera" checked>
        <span class="slider round"></span>
    </label><br><br>

    <label for="on_off_daisy" style="cursor: pointer;"
        title="Remember that when daisy chain is off the relay solenoid is active">Daisy ON/OFF:</label>
    <label class="switch">
        <input type="checkbox" id="on_off_daisy" checked>
        <span class="slider round"></span>
    </label>

    <!-- Configuration -->
    <h2>Configuration</h2>

    <!-- Lights configuration -->
    <h3>Video Lights</h3>
    <label style="cursor: pointer;" title="Between 0 and 100" for="light_brightness">Brightness:</label>
    <input type="number" id="light_brightness" name="light_brightness"><br>

    <!-- Container for dynamic time period inputs -->
    <label for="timePeriodsContainer">Light timetable</label>
    <div id="timePeriodsContainer"></div>

    <!-- Buttons to add and submit time periods -->
    <button onclick="addTimePeriod()">Add Time Period</button>
    <button onclick="setTimePeriods()">Update Time Periods</button>

    <p id="time_period_ack"></p> <!-- Display result -->

    <button style="cursor: pointer;" title="Triggers lights for 5 seconds" onclick="testLight()">Test
        lights</button><br>


    <!-- UVC configuration -->
    <h3>UVC LED</h3>
    <label for="uvc_time">Trigger time:</label>
    <input type="time" id="uvc_time" name="uvc_time"><br>

    <label for="uvc_duration">Duration:</label>
    <input type="number" id="uvc_duration" name="uvc_duration"><br>

    <button style="cursor: pointer;" title="Triggers UVC for 5 seconds" onclick="testUVC()">Test UVC</button><br>

    <h3><button onclick="setConfig()">Save configuration</button></h3>
    <p id="ack"></p>

    <script>
        function getConfig() {
            fetch('/get_config')
                .then(response => response.json())
                .then(data => {
                    // Load lights configuration

                    // TODO: Make loading in periods work
                    const periods = data.config["lights"]["periods"];
                    for (period in periods) {
                        addTimePeriod(startTime = period["start"], endTime = period["end"], active = period["active"])
                    }
                    document.getElementById("reset_time").value = data.config["reset_time"]
                    document.getElementById("light_brightness").value = data.config["lights"]["brightness"];

                    // Load UVC configuration
                    document.getElementById('uvc_time').value = data.config["uvc"]["time"];
                    document.getElementById('uvc_duration').value = data.config["uvc"]["duration"];
                })
                .catch(error => console.error("Error loading data", error));
        }

        function setConfig() {
            // Build new configuration
            const periods = [];
            const periodDivs = document.querySelectorAll('.time-period');

            periodDivs.forEach(div => {
                const startTime = div.querySelector('.start-time').value;
                const endTime = div.querySelector('.end-time').value;
                const active = div.dataset.active === "true";

                if (startTime && endTime) {  // Only add if both times are set
                    // periods.push({ start: startTime, end: endTime, active: active });
                    periods.push({ start: startTime, end: endTime, active: active });
                }
            });

            const newConfig = {
                reset_time: document.getElementById("reset_time").value,
                lights: {
                    periods: periods,
                    brightness: parseInt(document.getElementById("light_brightness").value, 10)
                },
                uvc: {
                    time: document.getElementById("uvc_time").value,
                    duration: parseFloat(document.getElementById("uvc_duration").value, 10)
                }
            }

            // Send new configuration
            fetch('/set_config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ newConfig })

            })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('ack').innerText = data.ack;
                });
        }

        function addTimePeriod(startTime = null, endTime = null, active = true) {
            // Create a new div to hold the start and end time inputs
            const container = document.getElementById('timePeriodsContainer');
            const periodDiv = document.createElement('div');
            periodDiv.classList.add('time-period');

            // Create start time input
            const startTimeInput = document.createElement('input');
            startTimeInput.type = 'time';
            startTimeInput.classList.add('start-time');
            // TODO: Does this work?
            startTimeInput.value = startTime ? startTime : "";
            startTimeInput.placeholder = "Start Time"

            // Create end time input
            const endTimeInput = document.createElement('input');
            endTimeInput.type = 'time';
            endTimeInput.classList.add('end-time');
            // TODO: Does this work?
            endTimeInput.value = endTime ? endTime : "";
            endTimeInput.placeholder = 'End Time';

            // Activate/Deactivate button
            const toggleButton = document.createElement('button');
            toggleButton.innerText = active ? 'Deactivate' : 'Activate';
            toggleButton.onclick = function () {
                const isActive = periodDiv.dataset.active === "true";
                periodDiv.dataset.active = isActive ? "false" : "true";
                toggleButton.innerText = isActive ? 'Activate' : 'Deactivate';
                periodDiv.classList.toggle('active', !isActive);
            };

            // Create remove button
            const removeButton = document.createElement('button');
            removeButton.innerText = 'Remove';
            removeButton.onclick = function () {
                container.removeChild(periodDiv);
            };

            // Append inputs and button to the period div
            periodDiv.appendChild(startTimeInput);
            periodDiv.appendChild(endTimeInput);
            periodDiv.appendChild(toggleButton);
            periodDiv.appendChild(removeButton);

            // Append the period div to the main container
            container.appendChild(periodDiv);

            // // Set the active class if the period is active
            // if (active) {
            //     periodDiv.classList.add('active');
            // }
        }

        function getTempAndPres() {
            fetch('/get_temp', { method: 'GET' })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('temperature').innerText = data.temperature;
                });

            fetch('/get_pres', { method: 'GET' })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('pressure').innerText = data.pressure;
                });
        }

        function testLight() {
            fetch('/test_light', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
            })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('result').innerText = data.result.message;
                });
        }

        function testUVC() {
            const test_param = confirm("WARNING, HARMFUL UVC LIGHT! Are you sure if you want to trigger UVC light for 5 seconds?");
            fetch('/test_UVC', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ test_param: test_param })
            })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('result').innerText = data.result.message;
                });
        }

        // Load config when config gets loaded
        window.onload = getConfig;
    </script>
</body>

</html>